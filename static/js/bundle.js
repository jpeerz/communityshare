!function(e){function t(s){if(r[s])return r[s].exports;var n=r[s]={exports:{},id:s,loaded:!1};return e[s].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";r(4),r(18),r(10)},function(e,t){e.exports=angular},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.controllers.authentication",["communityshare.services.authentication"]);e.controller("ResetPasswordController",["$scope","Authenticator","$routeParams","$location",function(e,t,r,s){var n=r.key;e.password={password:"",repeat_password:""},e.successfulReset=!1,e.failedReset=!1,e.passwordMethods={},e.resetPassword=function(){var r=t.resetPassword(n,e.password.password);r.then(function(){s.path("/login").search({}),e.successfulReset=!0},function(t){e.errorMessage=t})}}]),e.controller("RequestResetPasswordController",["$scope","Authenticator",function(e,t){e.email={value:""},e.successfulRequest=!1,e.failedRequest=!1,e.requestResetPassword=function(){var r=t.requestResetPassword(e.email.value);r.then(function(){e.successfulRequest=!0,e.errorMessage=""},function(t){e.successfulRequest=!1;var r="Failed to reset password";t&&(r+="Not found"===t?": Unknown email address":": "+t),e.errorMessage=r})}}]),e.controller("ConfirmEmailController",["$scope","Authenticator","$routeParams",function(e,t,r){var s=r.key;e.confirmed=!1,e.failedReset=!1;var n=t.confirmEmail(s);n.then(function(){e.confirmed=!0},function(t){e.errorMessage=t})}]),e.controller("DefaultController",["$scope","user","$location","User","signUp","Messages","$modal","support",function(e,t,r,s,n,a,o,i){e.support=i,t&&("choice"===t.accountCreationStatus?r.path("signup/choice"):"personal"===t.accountCreationStatus?r.path("signup/personal"):t.is_educator?r.path("matches"):r.path("messages"));var c=r.search().showModal;e.newUser=new s,e.emailRegex=/.+@.+\..+/i,e.passwordMethods={},e.pg="default",e.user_type={value:""},e.completeSplash=function(){e.newUser.name=e.newUser.firstName+" "+e.newUser.lastName;var t=n(e.newUser,e.newUser.password);t.then(function(){e.errorMessage="","communityPartner"===e.user_type.value?r.path("/signup/communitypartner"):"educator"===e.user_type.value?r.path("/signup/educator"):r.path("signup/choice")},function(t){e.errorMessage=t})},e.showTerms=function(){o.open({templateUrl:"./static/templates/terms.html",controller:"ModalController"})},e.showPrivacy=function(){o.open({templateUrl:"./static/templates/privacy.html",controller:"ModalController"})},e.showChoiceText=function(){o.open({templateUrl:"./static/templates/choice_educator_modal.html",controller:"ModalController"})},e.showEducatorText=function(){o.open({templateUrl:"./static/templates/choice_educator_modal.html",controller:"ModalController"})},e.showPartnerText=function(){o.open({templateUrl:"./static/templates/choice_partner_modal.html",controller:"ModalController"})},"terms"==c&&e.showTerms(),"privacy"==c&&e.showPrivacy()}]),e.controller("AuthRedirectController",["$scope","Authenticator","Messages",function(e,t,r){e.resendEmailConfirmation=function(){var e=t.requestConfirmEmail();e.then(function(){r.info("Sent email confirmation email.")},function(e){r.error(e)})}}]),e.controller("LoginController",["Session","$scope","$location","Authenticator",function(e,t,r,s){var n=r.search()["goto"];t.email={value:void 0},t.password={value:void 0},t.errorMessage="",t.login=function(){var a=s.authenticateWithEmailAndPassword(t.email.value,t.password.value);a.then(function(){e.activeUser.email_confirmed?(r.search("goto",null),n?r.path(n):r.path("/")):r.path("/auth_redirect")},function(e){var r="";e&&(r=": "+e),t.errorMessage="Authentication failed"+r})}}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.controllers.conversation",["communityshare.services.authentication","communityshare.services.utility","communityshare.services.conversation"]),n=function(e,t){var r="";t&&(r=": "+t);var s=e+r;return s};e.controller("MessagesController",["$scope","Session","Conversation","$location","$modal",function(e,t,r,s,n){e.Session=t;var a=t.activeUser;if(a){var o=r.get_many({user_id:a.id},!0);o.then(function(t){t.sort(function(e,t){return e.datetime_last_message<t.datetime_last_message}),e.conversations=t},function(e){})}e.showConversation=function(e){s.path("/conversation/"+e)},e.showThankYou=function(){n.open({templateUrl:"./static/templates/community_partner_thankyou.html",controller:"ModalController"})};var i=s.search().first;i&&e.showThankYou()}]),e.controller("ConversationController",["$scope","$q","$location","$timeout","$modal","Session","Conversation","Message","User","Share","makeDialog","conversation",function(e,t,r,s,a,o,i,c,u,l,d,h){if(e.Session=o,void 0!==h&&void 0!==o.activeUser){l.get_many({conversation_id:h.id});e.otherUser=void 0,e.conversation=h,e.newMessage=void 0;var m=function(){var e=new c({conversation_id:h.id,sender_user_id:o.activeUser.id,content:""});return e},v=function(t){var r="Failed to load conversation",s=n(r,t);e.errorMessage=s},f=function(){var t=i.get(h.id,!0);t.then(function(t){e.conversation=t,s(f,5e3),e.conversationErrorMessage=""},function(t){var r="Failed to load conversation",s=n(r,t);e.conversationErrorMessage=s})},p=function(){var t=l.get_many({conversation_id:h.id},!0);t.then(function(t){g(t),e.shares=t,s(p,5e3),e.sharesErrorMessage=""},function(t){var r="Failed to load shares",s=n(r,t);e.sharesErrorMessage=s})};h.markMessagesAsViewed(),h.userA.id===o.activeUser.id?e.otherUser=h.userB:e.otherUser=h.userA,e.messageHighlightClasses={},e.messageHighlightClasses[o.activeUser.id]="highlight1",e.messageHighlightClasses[e.otherUser.id]="highlight2",e.newMessage=m(),p(),s(f,5e3),e.createNewShare=function(){var t=h.makeShare();e.editShare(t)},e.editShare=function(e){var t={templateUrl:"./static/templates/share_edit.html",controller:"EditShareController",resolve:{share:function(){return e}}};a.open(t)};var g=function(t){var r=l.sortShares(t);e.futureShares=r.future,e.pastShares=r.past};e.sendMessage=function(){var t=e.newMessage.save();t.then(function(t){t.sender_user=o.activeUser,e.conversation.messages.push(t),e.newMessage=m()},v)},e.now=new Date,e.reviewEvent=function(e){r.path("/event/"+e.id)},e.confirmShare=function(e){e.save()},e.cancelShare=function(t){var r="Cancel Share",s="Do you really want to cancel this share with "+e.otherUser.name,a=[{result:"yes",label:"Yes",cssClass:"btn-primary"},{result:"no",label:"No"}],o=d(r,s,a);o.result.then(function(r){if("yes"===r){var s=t.destroy();s.then(function(){},function(t){var r="Failed to cancel share",s=n(r,t);e.errorMessage=s})}})}}}]),e.controller("NewConversationController",["Session","$scope","$modalInstance","userId","searchId","User","Conversation","Message","Authenticator","Messages",function(e,t,r,s,a,o,i,c,u,l){var d=o.get(s);t.Session=e,t.errorMessage="",e.activeUser.email_confirmed||o.get(e.activeUser.id,!0),t.conversation=new i({title:void 0,search_id:a,userA_id:e.activeUser.id,userB_id:s}),t.resendEmailConfirmation=function(){var e=u.requestConfirmEmail();e.then(function(){l.info("Sent email confirmation email.")},function(e){l.error(e)})},t.message=new c({conversation_id:void 0,sender_user_id:e.activeUser.id,content:void 0}),d.then(function(e){t.user=e}),t.cancel=function(){r.close()},t.startConversation=function(){var e=t.conversation.save();e.then(function(e){t.errorMessage="",t.message.conversation_id=e.id;var s=t.message.save();s.then(function(){r.close(e)},function(e){var r="Failed to save message";t.errorMessage=n(r,e)})},function(e){var r="Failed to save conversation";t.errorMessage=n(r,e)})}}])},function(e,t,r){"use strict";r(2),r(6),r(9),r(7),r(5),r(3),r(8)},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.controllers.message",["ngAnimate"]);e.controller("MessageController",["$scope","Messages",function(e,t){e.messages=t}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.controllers.misc",["communityshare.services.authentication","communityshare.services.modal","communityshare.services.statistics","communityshare.services.message"]);e.controller("ModalController",["$scope","$modalInstance",function(e,t){e.closeModal=function(){t.close()}}]),e.controller("NavigationController",["$scope","Session","Authenticator","$location",function(e,t,r,s){e.Session=t,e.logout=function(){r.clean(),s.path("")}}]),e.controller("MainController",["$scope","Session",function(e,t){e.Session=t}]),e.controller("AdminController",["Session","$scope","$location","$http","getStatistics",function(e,t,r,s,n){t.Session=e,t.searchText={value:""},t.now=new Date,t.tomorrow=new Date,t.tomorrow.setDate(t.tomorrow.getDate()+1),t.daysAgo7=new Date,t.daysAgo7.setDate(t.daysAgo7.getDate()-6),t.daysAgo30=new Date,t.daysAgo30.setDate(t.daysAgo7.getDate()-29),t.searchForUsers=function(){var e={searchText:t.searchText.value};r.path("/searchusers").search(e)},t.activateEmails=function(){s({method:"POST",url:"/api/activate_email"})},t.outputUserData=function(){s({method:"GET",url:"/api/dump_csv"}).success(function(e,t,r,s){console.log(e)}).error(function(e,t,r,s){console.log(t)})};var a=n();t.statistics=[],a.then(function(e){for(var r in e){var s=new Date(r);e[r].date=s,t.statistics.push(e[r])}var n=function(e,t){return e.date>t.date?1:e.date<t.date?-1:0};t.statistics.sort(n);var a=t.statistics.length;t.statisticsDate=t.statistics[a-1].date,t.nTotalUsers=t.statistics[a-1].n_total_users,t.nTotalEvents=t.statistics[a-1].n_total_events_done,t.nUpcomingEvents=t.statistics[a-1].n_upcoming_events,t.newUsersIn7Days=0,t.eventsIn7Days=0;for(var o=0;o<7;o++)t.newUsersIn7Days+=t.statistics[a-1-o].n_new_users,t.eventsIn7Days+=t.statistics[a-1-o].n_events_done;t.newUsersIn30Days=t.newUsersIn7Days,t.eventsIn30Days=t.eventsIn7Days;for(var i=7;i<30;i++)t.newUsersIn30Days+=t.statistics[a-1-i].n_new_users,t.eventsIn30Days+=t.statistics[a-1-i].n_events_done})}]),e.controller("NavbarController",["$scope","Messages","Session","$modal","Authenticator","$location","makeDialog",function(e,t,r,s,n,a,o){e.deleteAccount=function(){var e="Delete Account",s="Do you really want to delete your Community Share account?",i=[{result:"yes",label:"Yes"},{result:"no",label:"No",cssClass:"btn-primary"}],c=o(e,s,i);c.result.then(function(e){if("yes"===e){var s=r.activeUser.destroy();s.then(function(){n.clean(),a.path("/")},function(e){t.error(e)})}})}}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.controllers.search",["communityshare.controllers.conversation"]);e.controller("MatchesController",["$scope","Session","Search","$location","labelMapping","makeDialog","startConversation","Messages","$modal",function(e,t,r,s,n,a,o,i,c){e.Session=t,e.labelMapping=n,e.labelClasses={gradeLevels:"grade-level-button",engagementLevels:"engagement-button",subjectAreas:"subject-area-button",undefined:"subject-area-button"};var u=t.activeUser;e.infoMessage="Loading searches...",e.errorMessage="",e.title="",e.goToConversation=function(e){s.path("/conversation/"+e.id)},e.showThankYou=function(){c.open({templateUrl:"./static/templates/educator_thankyou.html",controller:"ModalController"})};var l=s.search().first;if(l&&e.showThankYou(),u){var d=r.get_many({searcher_user_id:u.id},!0);d.then(function(t){e.infoMessage="",e.errorMessage="",e.searches=t;var r=function(e,t){var r=-1;return e.created===t.created?r=0:e.created<t.created&&(r=1),r};e.searches.sort(r);var s=!1;e.page=0;for(var n=e.page,a=0;a<e.searches.length;a++){var o=e.searches[a];!s&&o.labels.length>0&&(e.getMatches(o,n),s=!0)}})}e.getMatches=function(t,s){e.page=s;var n=r.getResults(t.id,s);t.show=!0,t.infoMessage="Loading matches...",t.errorMessage="",n.then(function(e){t.matches=e,t.infoMessage="",t.errorMessage=""},function(e){t.infoMessage="",t.errorMessage=e})},e.startConversation=o,e.editProfile=function(){s.path("settings")},e.deleteSearch=function(e){var t="Delete Search",r="Do you really want to delete this search?  Others will no longer be able to find you by matching to the contents of this search.",s=[{result:"yes",label:"Yes"},{result:"no",label:"No",cssClass:"btn-primary"}],n=a(t,r,s);n.result.then(function(t){if("yes"===t){var r=e.destroy();r.then(function(){},function(e){i.error(e)})}})},e.goToPage=function(t,r){e.page=r,e.getMatches(t,r)},e.paginationRange=function(t){var r,s,n;for(s=e.page,r=[],s<5&&(s=0,t=5),s>=5&&(t=s+2,s-=2),n=s;n<=t;n++)r.push(n);return r}}]),e.controller("SearchResultsController",["Session","$scope","$location","$routeParams","$modal","Search","Messages","labelMapping",function(e,t,r,s,n,a,o,i){t.Session=e;var c=s.searchId;if(t.infoMessage="Searching for matches...",t.errorMessage="",t.title="",t.goToConversation=function(e){r.path("/conversation/"+e.id)},t.labelClasses={gradeLevels:"light-yellow-button",engagementLevels:"light-blue-button",subjectAreas:"light-green-button",undefined:"light-green-button"},t.labelMapping=i,void 0!==c){var u=a.getResults(c);u.then(function(e){t.searches=e,0===e.length?t.infoMessage="No matches found.":(t.infoMessage="","educator"===e[0].searcher_role?t.title="Best Educator Matches":t.title="Best Community Partner Matches"),t.errorMessage=""},function(e){var r="";e&&(r=": "+e),t.errorMessage="Failed to find matches"+r})}}]),e.controller("SearchEditController",["Session","$location","$scope","$routeParams","Search","Messages",function(e,t,r,s,n,a){r.Session=e;var o=s.searchId;if(void 0!==o){var i=n.get(o);i.then(function(e){r.search=e},function(e){a.error(e)})}else{var c,u;e.activeUser.is_educator?(c="educator",u="partner"):(c="partner",u="educator"),r.search=new n({searcher_user_id:e.activeUser.id,searcher_role:c,searching_for_role:u,zipcode:e.activeUser.zipcode,labels:[]})}r.saveSettings=function(){var e=r.search.save();e.then(function(){t.path("/matches")},function(e){a.error(e)})},r.searchText={value:""},r.userSearch=function(){r.searchText.value&&t.path("/searchusers/"+r.searchText.value)}}]),e.controller("SearchUsersController",["$scope","$location","$q","User","Session","$routeParams","parseyyyyMMdd","startConversation",function(e,t,r,s,n,a,o,i){e.Session=n,e.startConversation=i,e.infoMessage="Searching for matching users...",e.users=void 0,e.prevSearchText=a.searchText,e.searchText={value:a.searchText};var c=a.created_start;c&&(c=o(c));var u=a.created_stop;u&&(u=o(u)),e.start=c,e.stop=u;var l=function(){var t={"date_created.greaterthan":c,"date_created.lessthan":u,search_text:a.searchText},r=s.search(t);r.then(function(t){var r,s={},n=[];r=void 0===t.byName?t:t.byName.concat(t.byEmail);for(var a=0;a<r.length;a++){var o=r[a];o.id in s||(n.push(o),s[o.id]=!0)}var i=function(e,t){var r=e.name.toUpperCase(),s=t.name.toUpperCase();return r>s?1:r<s?-1:0};n.sort(i),e.users=n,e.infoMessage="",e.errorMessage=""},function(t){var r="";t&&(r=": "+t),e.errorMessage="Failed to load users"+r,e.infoMessage=""})};l(),e.newSearch=function(){t.path("/searchusers/"+e.searchText.value)}}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.controllers.share",["communityshare.services.share","communityshare.services.conversation"]);e.controller("SharesController",["Session","$scope","Share","startConversation",function(e,t,r,s){if(t.Session=e,t.startConversation=s,t.Session.activeUser){var n=r.get_many({user_id:e.activeUser.id},!0);t.errorMessage="",t.infoMessage="Loading shares...",n.then(function(e){t.errorMessage="",t.infoMessage="",t.shares=e;var s=r.sortShares(e);t.futureShares=s.future,t.pastShares=s.past},function(e){t.errorMessage=e})}}]),e.controller("ShareController",["Session","$scope","$routeParams","Share",function(e,t,r,s){t.Session=e;var n=r.shareId;if(void 0!==n){var a=s.get(n);a.then(function(e){t.share=e},function(e){var r="Failed to load share";e&&(r+=": "+e),t.errorMessage=r})}}]),e.controller("EditShareController",["$scope","share","$modalInstance",function(e,t,r){e.share=t,e.events=t.events,e.cancel=r.close;var s=function(t){var r="Failed to save share details";t&&(r+=": "+t),e.errorMessage=r},n=function(){r.close(e.share)};e.save=function(){for(var t=0;t<e.share.events.length;t++)e.share.events[t].updateDateTimes();var r=e.share.save();r.then(n,s)}}]),e.controller("EventsController",["$scope","$routeParams","Session","Evnt","parseyyyyMMdd",function(e,t,r,s,n){e.Session=r;var a={},o=t.start;o&&(o=n(o),a["datetime_start.greaterthan"]=o);var i=t.stop;i&&(i=n(i),a["datetime_start.lessthan"]=i),e.start=o,e.stop=i;var c=s.get_many(a);e.infoMessage="Loading events...",e.errorMessage="",c.then(function(t){e.events=t,e.infoMessage="",e.errorMessage=""},function(t){e.events=[],e.infoMessage="";var r="Failed to load events";t&&(r+=": "+t),e.errorMessage=r})}]),e.controller("EventController",["$scope","Session","evnt","Question",function(e,t,r,s){e.Session=t,e.evnt=r,e.questions=[];var n=s.get_many_with_answers(t.activeUser.id,{question_type:"post_event"},{about_event_id:r.id});n.then(function(t){e.questions=[];for(var s=0;s<t.length;s++){var n=t[s];n.answer.text||(n.answer.about_event_id=r.id,e.questions.push(n))}}),e.questions=[];var a=function(t){return function(){var r=e.questions.indexOf(t);r>=0&&e.questions.splice(r,1)}};e.save=function(){for(var t=[],r=[],s=0;s<e.questions.length;s++){var n=e.questions[s],o=n.answer;if(o.text){var i=o.save();i.then(a(n)),r.push(i),t.push(i)}}}}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.controllers.user",["communityshare.services.user","communityshare.directives.user","communityshare.directives.institutions","angularFileUpload"]);e.controller("UserController",["$scope","$routeParams","User","Session","Question","Conversation","Evnt","startConversation","makeDialog",function(e,t,r,s,n,a,o,i,c){e.Session=s;var u=t.userId,l=r.get(u);e.message="Loading user...",e.startConversation=i,l.then(function(t){e.message="",e.user=t,e.communityPartnerViewMethods.onUserUpdate&&e.communityPartnerViewMethods.onUserUpdate(t),e.educatorViewMethods.onUserUpdate&&e.educatorViewMethods.onUserUpdate(t)},function(){e.message="Could not find user with id="+u}),e.communityPartnerViewMethods={},e.educatorViewMethods={};var d=n.get_many_with_answers(u,{"question_type.in":["signup_community_partner","signup","signup_educator"]});if(e.Session.activeUser&&e.Session.activeUser.is_administrator){var h=a.get_many({user_id:u});h.then(function(t){e.conversations=t});var m=o.get_many({user_id:u});m.then(function(t){e.events=t})}d.then(function(t){e.questions=[];for(var r=0;r<t.length;r++){var s=t[r];s.answer.text&&e.questions.push(s)}}),e.deleteUser=function(){var t="Delete User",r='Do you really want to delete the account of "'+e.user.name+'"?',s=[{result:"yes",label:"Yes"},{result:"no",label:"No",cssClass:"btn-primary"}],n=c(t,r,s);n.result.then(function(t){if("yes"===t){var r=e.user.destroy();r.then(function(){},function(e){Messages.error(e)})}})}}]);var n=function(e,t,r,s,n,a,o,i,c){e.user=t,e.support=c,e.search=r,e.institutionMethods={},e.agreeToFollowHomePolicies={value:!1},e.questions=[];var u=o.get_many({"question_type.in":["signup_community_partner","signup","signup_educator"]});u.then(function(t){e.questions=t;for(var r=0;r<e.questions.length;r++){var s=e.questions[r];s.answer=new i({question_id:s.id})}}),e.enoughLabelsSelected=function(){var e=t.community_partner_profile_search.labels,r=t.educator_profile_search.labels,s=e.length>0||r.length>0;return s},e.submit=function(){if(e.enoughLabelsSelected()&&e.institutionMethods.isValid()&&(e.agreeToFollowHomePolicies.value||!r)){e.institutionMethods.form.submitted=!0,e.submitted=!0;var r=!1;t.educator_profile_search&&t.educator_profile_search.labels&&t.educator_profile_search.labels.length>0&&(r=!0);for(var o=t.save(),i=[o],c=0;c<e.questions.length;c++){var u=e.questions[c];u.answer.text&&i.push(u.answer.save())}a.all(i).then(function(){n.path("/signup/personal")},function(e){s.error(e)})}}};e.controller("SignupCommunityPartnerController",["$scope","Session","Messages","$location","$q","Search","Question","Answer","$modal",function(e,t,r,s,a,o,i,c,u){e.Session=t;var l,d=t.activeUser;d&&(l=d.community_partner_profile_search),e.isCommunityPartner=!0,n(e,d,l,r,s,a,i,c),e.showTutorial=function(){u.open({templateUrl:"./static/templates/community_partner_tutorial.html",controller:"ModalController"})},e.showTutorial()}]),e.controller("SignupPersonalController",["$scope","Session","$fileUploader","$http","$location","support",function(e,t,r,s,n,a){if(e.support=a,e.Session=t,e.user=t.activeUser,e.submitAttempted=!1,t.activeUser&&(e.user.wants_update_emails=!0,e.submit=function(t){if(e.submitAttempted=!0,t.$valid){o&&o.uploadAll();var r=e.user.save();r.then(function(){n.path("/"),n.search("first")},function(t){e.errorMessage=t})}},e.validImage=!0,a.fileUploader)){var o=e.uploader=r.create({scope:e,url:"/api/user/"+e.user.id+"/picture",headers:s.defaults.headers.common,filters:[function(t){var r="image"===t.type.substring(0,5);return e.validImage=r,o.queue.splice(0,o.queue.length),r}]});o.bind("afteraddingfile",function(){o.queue.length>1&&o.queue.splice(0,o.queue.length-1)})}}]),e.controller("SignupEducatorController",["$scope","Session","Messages","$location","$q","Search","Question","Answer","$modal",function(e,t,r,s,a,o,i,c,u){e.Session=t;var l,d=t.activeUser;d&&(l=d.educator_profile_search),e.isEducator=!0,e.questions=[],n(e,d,l,r,s,a,i,c),e.showTutorial=function(){u.open({templateUrl:"./static/templates/educator_tutorial.html",controller:"ModalController"})},e.showTutorial()}]),e.controller("SettingsController",["$scope","$location","Session","Messages","$q","Question","Answer","$fileUploader","$http","makeDialog","Authenticator","$rootScope","support",function(e,t,r,s,n,a,o,i,c,u,l,d,h){e.support=h;var m,v=!1;e.institutionMethods={};var f=function(r,s){if(!v&&(e.personalSettingsForm&&e.personalSettingsForm.$dirty||e.accountSettingsForm&&e.accountSettingsForm.$dirty||e.user.community_partner_profile_search&&e.user.community_partner_profile_search.dirty||e.user.educator_profile_search&&e.user.educator_profile_search.dirty)){var n="Changes not Saved",a="Do you really want to leave this page without saving your changes?",o=[{result:"yes",label:"Yes"},{result:"no",label:"No",cssClass:"btn-primary"}],i=u(n,a,o);i.result.then(function(e){if("yes"===e){m();var r=s.replace(/^.*\#/,"");t.path(r)}}),r.preventDefault()}};if(m=d.$on("$locationChangeStart",f),e.Session=r,r.activeUser){if(e.user=r.activeUser,e.isCommunityPartner=e.user.is_community_partner,e.isEducator=e.user.is_educator,e.properties={},e.settingsTabSet={},e.passwordMethods={},e.user){var p=a.get_many_with_answers(e.user.id,{"question_type.in":["signup_community_partner","signup_educator"]});p.then(function(t){e.questions=t})}e.$on("personalSettingsForm",function(t,r){e.personalSettingsForm=r.personalSettingsForm}),e.$on("accountSettingsForm",function(t,r){e.accountSettingsForm=r.accountSettingsForm});var g=function(t){var r="Failed to update settings";t&&(r+=": "+t),e.errorMessage=r,e.successMessage=""};if(h.fileUploader){e.validImage=!0;var y=e.uploader=i.create({scope:e,url:"/api/user/"+e.user.id+"/picture",headers:c.defaults.headers.common,filters:[function(t){var r="image"===t.type.substring(0,5);return e.validImage=r,y.queue.splice(0,y.queue.length),r}]});y.bind("afteraddingfile",function(){y.queue.length>1&&y.queue.splice(0,y.queue.length-1)})}e.resendEmailConfirmation=function(){var e=l.requestConfirmEmail();e.then(function(){s.info("Sent email confirmation email.")},function(e){s.error(e)})},e.save=function(){var s=e.user.save();y&&y.uploadAll();var a=[s];if(e.questions)for(var o=[],i=0;i<e.questions.length;i++){var c=e.questions[i].answer;if(c.text){var u=c.save();o.push(u),a.push(u)}}var l=n.all(a);s.then(function(e){r.activeUser.updateFromData(e.toData())},g),l.then(function(){v=!0,t.path("/")})}}}])},function(e,t,r){"use strict";r(13),r(15),r(12),r(11),r(14)},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.directives.institutions",["communityshare.services.user"]);e.directive("csInstitutions",["Session","Institution",function(e,t){return{scope:{user:"=",methods:"=",isEducator:"@",isCommunityPartner:"@"},templateUrl:"./static/templates/institution_adder.html",controller:["$scope",function(e){e.isEducator="true"===e.isEducator,e.isCommunityPartner="true"===e.isCommunityPartner,e.updateInstitutions=function(){e.noInstitutions&&(e.user.institution_associations=[],e.user.addNewInstitutionAssociation(),e.institutionsForm.submitted=!1)},e.$watch("institutionsForm",function(){e.methods.form=e.institutionsForm}),e.methods.isValid=function(){return e.institutionsForm.$valid||e.noInstitutions};var r=t.get_many();e.options={institutions:[],institutionTypes:[]},e.isCommunityPartner?(e.institutionTypes=["Corporation","Freelancer","Nonprofit","Academic","Government","Other"],e.roles=[]):e.isEducator&&(e.institutionTypes=["Public District School","Public Charter","Private School","Home School","Higher Education","Nonprofit","After School Program","Other"],e.roles=["Classroom teacher","Curriculum Coordinator","Administator","Parent","Other"]),0===e.user.institution_associations.length&&e.user.institution_associations.push({institution:{}}),r.then(function(t){e.institutions=t})}]}}]),e.directive("csInstitutionAssociationEdit",function(){return{templateUrl:"static/templates/institution_association.html",controller:["$scope",function(e){e.$watch("institutionsForm.submitted",function(){e.institutionsForm&&(e.submitted=e.institutionsForm.submitted)})}]}})},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.directives.labels",["communityshare.services.search"]);e.factory("makeBaseLabels",function(){var e=function(){var e={gradeLevels:{suggested:["K-5","6-8","9-12","College","Adult"],other:["K-3","4-5","6-8","9-12","Preschool"]},subjectAreas:{communityPartnerSuggested:["Science","Technology","Engineering","Math","Visual Arts","Digital Media","Wildlife Biology","English/Literature","Performing Arts","History","PE/Sports","Foreign Languages","Government","Health","Journalism","Culinary Arts","Entrepreneurship"],educatorSuggested:["Science","Technology","Engineering","Math","Visual Arts","Digital Media","Wildlife Biology","English/Literature","Performing Arts","History","PE/Sports","Foreign Languages","Government","Health","Journalism","Culinary Arts","Entrepreneurship"],other:[]},engagementLevels:{suggested:["Guest Speaker","Host Field Trip","Judge Student Competition","Participate in Career Day","Collaborate on a Class Project","Mentor Students","Brainstorm Curriculum Ideas with Educator","Hands-On Demonstration"],other:[]}},t={gradeLevels:e.gradeLevels.suggested.concat(e.gradeLevels.other),engagementLevels:e.engagementLevels.suggested.concat(e.engagementLevels.other),subjectAreas:e.subjectAreas.communityPartnerSuggested.concat(e.subjectAreas.educatorSuggested).concat(e.subjectAreas.other)},r={gradeLevels:e.gradeLevels.suggested,engagementLevels:e.engagementLevels.suggested,subjectAreas:e.subjectAreas.educatorSuggested},s={gradeLevels:e.gradeLevels.suggested,engagementLevels:e.engagementLevels.suggested,subjectAreas:e.subjectAreas.communityPartnerSuggested},n={gradeLevels:e.gradeLevels.suggested,engagementLevels:e.engagementLevels.suggested,subjectAreas:e.subjectAreas.communityPartnerSuggested.concat(e.subjectAreas.educatorSuggested)};return{educatorSuggested:r,communityPartnerSuggested:s,communityPartnerAndEducatorSuggested:n,all:t}};return e}),e.factory("labelMapping",["makeBaseLabels",function(e){var t=e().all,r={};for(var s in t)for(var n=0;n<t[s].length;n++){var a=t[s][n];r[a]=s}return r}]),e.factory("orderLabels",["labelMapping",function(e){var t=function(t){for(var r=[],s=[],n=[],a=0;a<t.length;a++){var o=t[a];"gradeLevels"===e[o]?r.push(o):"engagementLevels"==e[o]?n.push(o):s.push(o)}var i=r.concat(s).concat(n);return i};return t}]),e.factory("LabelDisplay",["makeBaseLabels","labelMapping",function(e,t){var r=function(r,s){this.search=r;var n=e();this.all={},this.active={},"educator"===s?this.all=n.educatorSuggested:this.all=n.communityPartnerSuggested;for(var a=0;a<r.labels.length;a++){var o=r.labels[a];this.active[o]=!0;var i=t[o];void 0===i&&(i="subjectAreas",this.all[i].push(o))}};return r.prototype.setSelected=function(e){this.active[e]=!0;var t=this.search.labels.indexOf(e);t===-1&&this.search.labels.push(e),this.search.dirty=!0},r.prototype.setUnselected=function(e){this.active[e]=!1;var t=this.search.labels.indexOf(e);t>=0&&this.search.labels.splice(t,1),this.search.dirty=!0},r.prototype.toggle=function(e){this.active[e]?this.setUnselected(e):this.setSelected(e)},r}]),e.directive("csNewLabel",function(){return{scope:{methods:"="},controller:["$scope",function(e){e.update=function(){e.methods.onUpdate&&e.methods.onUpdate()}}],link:function(e,t){t.bind("keydown",function(t){var r=13,s=9;t.keyCode!==r&&t.keyCode!==s||e.$apply(e.update)})}}});var n=function(e,t,r){e.display=new t(e.search,e.type),e.newLabel={name:""};var s=r();e.allLabels=[],s.then(function(t){e.allLabels=t},function(){}),e.typeaheadSelect=function(){e.newLabelMethods.onUpdate()},e.newLabelMethods={onUpdate:function(){var t,r,s,n;for(t=e.newLabel.name.split(","),s=0;s<t.length;s++)r=t[s].trim().toLowerCase(),r&&(n=e.display.all.subjectAreas.indexOf(r),n<0&&e.display.all.subjectAreas.push(r),e.display.setSelected(r));e.newLabel.name=""}},e.toggleLabel=function(t){e.onlyShowActive||e.display.toggle(t)}};n.$inject=["$scope","LabelDisplay","getAllLabels"],e.directive("csLabels",function(){return{scope:{search:"=",gradeLevelsTitle:"@",engagementLevelsTitle:"@",subjectAreasTitle:"@",subjectAreasLabel:"@",type:"@",onlyShowActive:"@"},templateUrl:"./static/templates/labels.html",controller:n}})},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.directives.mainview",["ui.bootstrap.alert"]);e.directive("csRegistrationWrapper",function(){return{templateUrl:"/static/templates/registration_wrapper.html",transclude:!0}}),e.directive("csStandardWrapper",function(){return{templateUrl:"/static/templates/standard_wrapper.html",transclude:!0}}),e.directive("csSplashWrapper",function(){return{templateUrl:"/static/templates/splash_wrapper.html",transclude:!0}}),e.directive("csSideNav",function(){return{templateUrl:"/static/templates/sidenav.html",replace:!0}}),e.directive("csNavBar",function(){return{templateUrl:"/static/templates/navbar.html",controller:"NavbarController",replace:!0}}),e.directive("csFooter",function(){return{templateUrl:"/static/templates/footer.html",replace:!0}}),e.directive("csUserAgreement",function(){return{templateUrl:"/static/templates/user_agreement.html"}}),e.directive("csForbidden",["Session",function(e){return{templateUrl:"/static/templates/forbidden.html",controller:["$scope","$location",function(t,r){t.thisLocation=r.path(),e.activeUser||r.path("/login").search("goto",t.thisLocation)}]}}]),e.directive("csDatepicker",function(){return{scope:{ngModel:"="},templateUrl:"/static/templates/datepicker.html",controller:["$scope",function(e){e.today=function(){e.ngModel=new Date},e.clear=function(){e.ngModel=null},e.minDate=new Date,e.maxDate=new Date,e.maxDate.setFullYear(e.maxDate.getFullYear()+1),e.open=function(t){t.preventDefault(),t.stopPropagation(),e.opened=!0},e.dateOptions={formatYear:"yy",startingDay:1}}]}}),e.directive("formSubmitted",function(){return{restrict:"A",require:"form",link:function(e,t){e.submitted=!1,t.on("submit",function(){e.$apply(function(){e.submitted=!0})})}}}),e.directive("inputErrorHelper",function(){return{restrict:"A",require:"^form",scope:{inputTag:"@",fieldName:"@"},link:function(e,t,r,s){var n=e.inputTag||"input",a=t.find(n),o=e.fieldName||a.attr("name"),i=t.scope();e.makeDirty=function(){var e=s[o];e.$setViewValue(e.$viewValue)},i.$watch("submitted",function(t){t&&e.makeDirty()}),a.bind("blur",function(){e.$apply(function(){e.makeDirty()})})}}})},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.directives.survey",[]);e.directive("csQuestion",function(){return{scope:{question:"=",answers:"="},controller:["$scope",function(e){
e.custom_answer=" "}],templateUrl:"static/templates/question.html"}})},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.directives.user",["communityshare.services.survey","communityshare.directives.survey"]);e.directive("csCommunityPartnerView",function(){return{scope:{methods:"=",user:"="},templateUrl:"./static/templates/community_partner_view.html",controller:["Session","$scope","CommunityPartnerUtils","Search","Messages",function(e,t,r,s,n){t.methods.onUserUpdate=function(e){if(e.is_community_partner){var s=e.getSearches(),a=r.searchesPromiseToSearchPromise(s);a.then(function(e){t.search=e},function(e){n.error(e)})}},t.user&&t.methods.onUserUpdate(t.user)}]}}),e.directive("csEducatorView",function(){return{scope:{methods:"=",user:"="},templateUrl:"./static/templates/educator_view.html",controller:["Session","$scope","Search","Messages",function(e,t,r,s){t.methods.onUserUpdate=function(e){var r=e.getSearches();r.then(function(e){for(var r=[],s=0;s<e.length;s++){var n=e[s];"educator"===n.searcher_role&&r.push(n)}t.searches=r},function(e){s.error(e)})},t.user&&t.methods.onUserUpdate(t.user)}]}}),e.directive("csParserHook",function(){return{require:"ngModel",scope:{methods:"="},link:function(e,t,r,s){var n=r.csParserHook;s.$parsers.push(function(t){var r;return e.methods[n]&&(r=e.methods[n](t)),r})}}}),e.directive("csMatch",function(){return{require:"ngModel",scope:{methods:"="},link:function(e,t,r,s){var n,a=r.csMatch,o=function(e,t){return void 0===e&&(e=""),void 0===t&&(t=""),e===t};s.$parsers.push(function(e){var t,r=o(e,n);return s.$setValidity("match",r),r&&(t=e),t}),e.methods[a]=function(e){n=e;var t=o(e,s.$viewValue);return s.$setValidity("match",t),e}}}}),e.directive("emitScope",function(){return{link:function(e,t,r){e.$emit(r.emitScope,e)}}})},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.services.authentication",["ngResource","communityshare.services.user","communityshare.services.conversation"]);e.factory("activeUserLoader",["SessionBase",function(e){return e.getActiveUserPromise}]),e.factory("SessionBase",["$q",function(e){var t,r={};return r.clearUser=function(){t=e.defer(),r.activeUser=void 0},r.setUser=function(e){t.resolve(e),r.activeUser=e,e&&e.updateUnviewedConversations()},r.getActiveUserPromise=function(){return t.promise},r.clearUser(),r}]),e.factory("Session",["SessionBase","Authenticator",function(e,t){return t.authenticateFromCookie(),e}]),e.factory("Authenticator",["$q","$http","User","SessionBase","$cookies","$cookieStore",function(e,t,r,s,n,a){var o={};return o.clean=function(){t.defaults.headers.common.Authorization="",a.remove("apiKey"),s.clearUser(),s.setUser(void 0)},o.setApiKey=function(e){t.defaults.headers.common.Authorization="Basic:api:"+e,n.apiKey=e},o.setEmail=function(e){n.email=e},o.authenticateFromCookie=function(){var t=e.defer(),a=n.apiKey,i=n.email;if(a&&i){o.setApiKey(a);var c=r.getByEmail(i);c.then(function(e){s.setUser(e)},function(e){s.setUser(void 0),t.reject(e)})}else{var u="No cookie found";s.setUser(void 0),t.reject(u)}},o.authenticateWithEmailAndPassword=function(e,a){t.defaults.headers.common.Authorization="Basic:"+e+":"+a;var i="/api/requestapikey",c=t({url:i,method:"GET"});c.then(function(t){var r=t.data.apiKey;o.setApiKey(r),n.email=e},function(e){});var u=r.getByEmail(e);return s.clearUser(),u.then(function(e){s.setUser(e)},function(e){s.setUser(void 0)}),u},o.requestResetPassword=function(r){var s="api/requestresetpassword/"+r,n=e.defer(),a=t({url:s,method:"GET"});return a.then(function(e){n.resolve(e.data)},function(e){var t;e.data&&e.data.message&&(t=e.data.message),n.reject(t)}),n.promise},o.requestConfirmEmail=function(){var r=e.defer(),s="api/requestconfirmemail",n=t({url:s,method:"GET"});return n.then(function(e){r.resolve(void 0)},function(e){var t="Failed to send email confirmation email";e.data&&e.data.message&&(t+=": "+e.data.message),e.reject(t)}),r.promise},o.confirmEmail=function(n){var a=e.defer(),i="api/confirmemail",c=t({url:i,method:"POST",data:{key:n}});return s.clearUser(),c.then(function(e){var t=e.data.apiKey,n=new r(e.data.data);o.setApiKey(t),s.setUser(n),a.resolve(n)},function(e){var t="";e.data&&e.data.message&&(t=e.data.message),a.reject(t)}),a.promise},o.resetPassword=function(r,s){var n=e.defer(),a="api/resetpassword",o=t({url:a,method:"POST",data:{key:r,password:s}});return o.then(function(e){n.resolve(e.data)},function(e){var t="";e.data&&e.data.message&&(t=e.data.message),n.reject(t)}),n.promise},o}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.services.conversation",["communityshare.services.item","communityshare.services.user","communityshare.services.share"]);e.factory("conversationLoader",["Conversation","$q",function(e,t){return function(r){var s=t.defer(),n=e.get(r);return n.then(function(e){s.resolve(e)},function(){s.resolve(void 0)}),s.promise}}]),e.factory("Conversation",["SessionBase","itemFactory","UserBase","Message","Messages","Share",function(e,t,r,s,n,a){var o=t("conversation");return o.prototype.toData=function(){for(var e=["id","title","search_id","userA_id","userB_id"],t={},r=0;r<e.length;r++){var s=e[r];t[s]=this[s]}return t},o.prototype.updateFromData=function(t){var n=this;for(var a in t)this[a]=t[a];if(this.userA&&(this.userA=r.make(this.userA)),this.userB&&(this.userB=r.make(this.userB)),e.getActiveUserPromise().then(function(e){e&&(e.id===n.userA_id?n.otherUser=n.userB:e.id===n.userB_id&&(n.otherUser=n.userA))}),this.datetime_last_message=void 0,this.messages)for(var o=0;o<this.messages.length;o++){var i=this.messages[o];this.messages[o]=new s(i),i.sender_user_id===this.userA.id?this.messages[o].sender_user=this.userA:i.sender_user_id===this.userB.id&&(this.messages[o].sender_user=this.userB),(void 0===this.datetime_last_message||this.messages[o].date_created>this.datetime_last_message)&&(this.datetime_last_message=this.messages[o].date_created)}},o.prototype.getUnviewedMessages=function(){var e=[];if(this.otherUser)for(var t=0;t<this.messages.length;t++){var r=this.messages[t];r.sender_user_id!==this.otherUser.id||r.viewed||e.push(r)}return e},o.prototype.markMessagesAsViewed=function(){for(var e=this.getUnviewedMessages(),t=0;t<e.length;t++){var r=e[t];r.viewed=!0,r.save()}},o.prototype.makeShare=function(){var t;if(this.otherUser){var r,s;e.activeUser.is_educator?r=e.activeUser.id:e.activeUser.is_community_partner&&(s=e.activeUser.id),this.otherUser.is_educator?r=this.otherUser.id:this.otherUser.is_community_partner&&(s=this.otherUser.id),void 0===r||void 0===s?n.error("A share required both an educator and a community partner."):(t=new a({conversation_id:this.id,educator_user_id:r,community_partner_user_id:s,title:void 0,description:void 0,educator_approved:!1,community_partner_approved:!1}),t.addNewEvent())}return t},o.getUnviewedForUser=function(e){var t={user_id:e,with_unviewed_messages:!0},r=o.get_many(t=t);return r},o}]),e.factory("Message",["itemFactory",function(e){var t=e("message");return t.prototype.toData=function(){for(var e=["id","conversation_id","sender_user_id","content","date_created","user"],t={},r=0;r<e.length;r++){var s=e[r];t[s]=this[s]}return t},t.prototype.updateFromData=function(e){for(var t in e)this[t]=e[t];this.date_created?this.date_created=new Date(this.date_created):this.date_created=new Date},t}])},function(e,t,r){"use strict";r(16),r(20),r(22),r(17),r(29),r(24),r(19),r(28),r(23),r(21),r(27),r(26),r(25)},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.services.item",["ngResource","ngCookies"]);e.factory("itemFactory",["$q","$http","SessionBase",function(e,t,r){var s=function(s){var n=function(e){this.updateFromData(e),this.initialize&&this.initialize()};return n.cache={},n.searchCache={},n.prototype.toData=function(){var e=JSON.parse(JSON.stringify(this));return e},n.prototype.clone=function(){var e=this.toData(),t=new n(e);return t},n.makeUrl=function(e){var t="/api/"+s;return void 0!==e&&(t+="/"+e),t},n.make=function(e){var t=n.cache[e.id];return void 0===t?(t=new n(e),n.cache[e.id]=t):t.updateFromData(e),t},n.get=function(r,s){var a=e.defer(),o=n.cache[r];if(void 0===o||s){var i=t({method:"GET",url:n.makeUrl(r)});i.then(function(e){var t=n.make(e.data.data);a.resolve(t)},function(e){a.reject(e.message)})}else a.resolve(o);return a.promise},n.get_many=function(r,s){var a=e.defer(),o=JSON.stringify(r),i=n.searchCache[o];if(void 0===i||s){var c=t({method:"GET",url:n.makeUrl(),params:r});c.then(function(e){for(var t=[],r=0;r<e.data.data.length;r++){var s=n.make(e.data.data[r]);t.push(s)}n.searchCache[o]=t,a.resolve(t)},function(e){a.reject(e.data.message)})}else a.resolve(i);return a.promise},n.prototype._baseUpdateFromData=function(e){for(var t in e)this[t]=e[t]},n.prototype.updateFromData=function(e){for(var t in e)this[t]=e[t]},n.prototype.save=function(){var s,a=this,o=e.defer();s=void 0===this.id?"POST":"PUT";var i=t({method:s,url:n.makeUrl(this.id),data:this.toData()});return i.then(function(e){a.updateFromData(e.data.data),void 0!==e.data.user&&r.activeUser.updateFromData(e.data.user),o.resolve(a)},function(e){var t="";e.data.message&&(t=e.data.message),o.reject(t)}),o.promise},n.prototype.destroy=function(){var r=this,s=e.defer(),a=t({method:"DELETE",url:n.makeUrl(this.id)});return a.then(function(){r.active=!1,n.cache[r.id]=void 0;for(var e in n.searchCache){var t=n.searchCache[e],a=t.indexOf(r);a>=0&&t.splice(a,1)}s.resolve()},function(e){var t="";e.data.message&&(t=e.data.message),s.reject(t)}),s.promise},n};return s}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.services.map",[]);e.factory("locationFromAddress",["$q",function(e){var t=new google.maps.Geocoder,r=function(r){var s=e.defer();return t.geocode({address:r},function(e,t){t===google.maps.GeocoderStatus.OK?s.resolve(e[0].geometry.location):s.reject("Geocode was not successful for the following reason: "+t)}),s.promise};return r}]),e.factory("Map",["$q","locationFromAddress",function(e,t){var r=function(e){var t=document.getElementById(e);if(t){var r=new google.maps.LatLng(32.223303,(-110.970905)),s={zoom:10,center:r};this.map=new google.maps.Map(document.getElementById(e),s)}};return r.prototype.codeAddress=function(r){var s=this,n=e.defer(),a=t(r);return a.then(function(e){s.map&&(s.map.setCenter(e),s.map.setZoom(13)),n.resolve(e)},function(e){n.reject(e)}),n.promise},r}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.services.message",[]);e.factory("Messages",["$log","$timeout",function(e,t){var r=5e3,s=function(e,t){this.text=e,this.type=t},n=function(){this.messages=[]};return n.prototype.error=function(n){var a=this,o=new s(n,"danger");this.messages.push(o),e.error(n),t(function(){a.removeMessage(o)},r)},n.prototype.info=function(t){var r=new s(t,"info");this.messages.push(r),e.info(t)},n.prototype.removeMessage=function(e){var t=this.messages.indexOf(e);t>=0&&this.messages.splice(t,1)},new n}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.services.modal",[]);e.factory("makeDialog",["$modal",function(e){return function(t,r,s){var n={templateUrl:"./static/templates/dialog.html",controller:function(e,t,r,s,n){e.title=r,e.msg=s,e.btns=n,e.onClick=function(e){t.close(e)}},resolve:{title:function(){return t},msg:function(){return r},btns:function(){return s}}},a=e.open(n);return a}}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.services.search",["communityshare.services.item","communityshare.services.user"]);e.factory("getAllLabels",["$q","$http",function(e,t){var r=function(){var r="/api/labels",s=t({method:"GET",url:r}),n=e.defer();return s.then(function(e){var t=e.data.data;n.resolve(t)},function(e){var t=e.data.message;n.reject(t)}),n.promise};return r}]),e.factory("LabelMapping",["makeBaseLabels",function(e){var t=e().all,r={};for(var s in t)for(var n=0;n<t[s].length;n++){var a=t[s][n];r[a]=s}return r}]),e.factory("Search",["itemFactory","$q","$http","labelMapping","UserBase","orderLabels",function(e,t,r,s,n,a){var o=function(e,t){for(var r={},s=[],n=[],a=0;a<e.length;a++)n.push(e[a].toLowerCase());for(var o=[],i=0;i<t.length;i++)o.push(t[i].toLowerCase());for(var c=0;c<n.length;c++){var u=n[c],l=o.indexOf(u);l===-1&&s.push(e[c]),r[e[c]]=l>=0,l!==-1&&(r[t[l]]=!0)}var d={matching:r,missing:s};return d},i=e("search");return i.prototype.initialize=function(){this.searcher_user&&(this.searcher_user=n.make(this.searcher_user))},i.prototype.updateFromData=function(e){for(var t in e)this[t]=e[t];this.created&&(this.created=new Date(this.created)),this.labels&&(this.labels=a(this.labels))},i.prototype.isProfile=function(e){var t=e.community_partner_profile_search.id===this.id||e.educator_profile_search.id===this.id;return t},i.getResults=function(e,s){var n=t.defer();"undefined"==typeof s&&(s=0);var a="/api/search/"+e+"/"+s+"/results",c=r({method:"GET",url:a}),u=i.get(e),l=t.all([u,c]);return l.then(function(e){for(var t=e[0],r=e[1],s=[],a=0;a<r.data.data.length;a++){var c=new i(r.data.data[a]),u=o(t.labels,c.labels);c.matchingLabels=u.matching,c.missingLabels=u.missing,c.targetLabels=t.labels,s.push(c)}n.resolve(s)},function(e){var t="";e.message&&(t=e.message),n.reject("Error loading search results: "+t)}),n.promise},i}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.services.share",["communityshare.services.item"]);e.factory("Share",["itemFactory","EvntBase","SessionBase",function(e,t,r){var s=e("share");return s.prototype.updateFromData=function(e){if(this._baseUpdateFromData(e),this.largest_datetime_start=void 0,this.events)for(var s=0;s<this.events.length;s++)this.events[s]=t.make(this.events[s]),(void 0===this.largest_datetime_start||this.events[s].datetime_start>this.largest_datetime_start)&&(this.largest_datetime_start=this.events[s].datetime_start);else this.events=[];var n=!1,a=!1;r.activeUser&&(n=r.activeUser.id===this.community_partner_user_id,a=r.activeUser.id===this.educator_user_id),this.educator&&this.community_partner&&(a?this.otherUser=this.community_partner:n&&(this.otherUser=this.educator)),this.canApprove=!1,a&&!this.educator_approved&&this.community_partner_approved?this.canApprove=!0:n&&!this.community_partner_approved&&this.educator_approved&&(this.canApprove=!0),this.approved=this.educator_approved&&this.community_partner_approved},s.prototype.hasActiveEvent=function(){for(var e=!1,t=0;t<this.events.length;t++){var r=this.events[t];r.id>=0&&r.active&&(e=!0)}return e},s.prototype.addNewEvent=function(){var e=new t({share_id:this.id,title:this.title,active:!0,description:"",datetime_start:void 0,datetime_stop:void 0});this.events.push(e)},s.sortShares=function(e){for(var t=[],r=[],s=0;s<e.length;s++){var n=e[s];n.largest_datetime_start>new Date?t.push(n):r.push(n)}return t.sort(function(e,t){return e.datetime_start>t.datetime_start}),r.sort(function(e,t){return e.datetime_start>t.datetime_start}),{future:t,past:r}},s}]),e.factory("EvntBase",["itemFactory",function(e){var t=e("event");return t}]);var n=function(e){var t=new Date(e.getFullYear(),e.getMonth(),e.getDate()),r=new Date(1900,0,1,e.getHours(),e.getMinutes()),s={date:t,time:r};return s},a=function(e,t){var r=new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes());return r};e.factory("eventLoader",["Evnt","$q",function(e,t){return function(r){var s=t.defer(),n=e.get(r);return n.then(function(e){s.resolve(e)},function(){s.resolve(void 0)}),s.promise}}]),e.factory("Evnt",["EvntBase","Share",function(e,t){var r=new Date;return r.setHours(0,0,0,0),e.prototype.updateFromData=function(e){this._baseUpdateFromData(e),void 0===this.datetime_start&&(this.datetime_start=r),void 0===this.datetime_stop&&(this.datetime_stop=r),this.datetime_start=new Date(this.datetime_start);var s=n(this.datetime_start);this.date=s.date,this.time_start=s.time,this.datetime_stop=new Date(this.datetime_stop);var a=n(this.datetime_stop);this.time_stop=a.time,this.share&&(this.share=new t(this.share))},e.prototype.updateDateTimes=function(){this.datetime_start=a(this.date,this.time_start),this.datetime_stop=a(this.date,this.time_stop)},e}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.services.stacktrace",[]);e.factory("stacktraceService",function(){return{print:printStackTrace}}),e.provider("$exceptionHandler",{$get:["errorLogService",function(e){return e}]}),e.factory("errorLogService",["$log","$window","stacktraceService",function(e,t,r){function n(n,a){e.error.apply(e,arguments);try{var o=n.toString(),i=r.print({e:n});$.ajax({type:"POST",url:"http://localhost:3030/error-log",contentType:"application/json",data:s.toJson({errorUrl:t.location.href,errorMessage:o,stackTrace:i,cause:a||"",browser:navigator.userAgent})})}catch(c){e.warn("Error logging failed"),e.log(c)}}return n}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.services.statistics",[]);e.factory("getStatistics",["$q","$http",function(e,t){var r=function(){var r="/api/statistics",s=t({method:"GET",url:r}),n=e.defer();return s.then(function(e){n.resolve(e.data.data)},function(e){var t="Failed to fetch statistics";e.data.message&&(t+=": "+e.data.message),n.reject(t)}),n.promise};return r}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.services.survey",[]);e.factory("Answer",["itemFactory",function(e){var t=e("answer");return t}]),e.factory("Question",["itemFactory","$q","Answer",function(e,t,r){var s=e("question");return s.get_many_with_answers=function(e,n,a,o){var i=t.defer(),c=s.get_many(n,o);a||(a={}),a.responder_id=e;var u=r.get_many(a);return t.all([c,u]).then(function(e){for(var t=e[0],s=e[1],n={},a=0;a<s.length;a++){var o=s[a];o.question_id in n||(n[o.question_id]=[]),n[o.question_id].push(o)}for(var c=function(e,t){return e.created_date-t.created_date},u=0;u<t.length;u++){var l=t[u],d=[];l.id in n&&(d=n[l.id]),d.sort(c),d.length>0?(l.answer=d[0],l.answers=d):l.answer=new r({question_id:l.id})}i.resolve(t)},function(e){i.reject(e)}),i.promise},s}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.services.user",["communityshare.services.item","communityshare.services.message"]);e.factory("signUp",["$q","$http","User","Authenticator","Session","Messages",function(e,t,r,s,n,a){var o=function(o,i){var c=e.defer(),u=t({method:"POST",url:"/api/usersignup",data:{user:o.toData(),password:i}});return n.clearUser(),u.then(function(e){var t=r.make(e.data.data);s.setApiKey(e.data.apiKey),s.setEmail(t.email),t.warningMessage&&a.error("Failed to send email to confirm address."),n.setUser(t),t.updateUnviewedConversations(),c.resolve(t)},function(e){n.setUser(void 0),c.reject(e.data.message)}),c.promise};return o}]),e.factory("UserBase",["itemFactory",function(e){var t=e("user");return t.prototype.toData=function(){this.cleanInstitutionAssociations();var e=JSON.parse(JSON.stringify(this));return this.id?(e.educator_profile_search=this.educator_profile_search.toData(),e.community_partner_profile_search=this.community_partner_profile_search.toData()):(e.educator_profile_search=null,e.community_partner_profile_search=null),e},t}]),e.factory("userLoader",["User","$q",function(e,t){return function(r){var s=t.defer(),n=e.get(r);return n.then(function(e){s.resolve(e)},function(){s.resolve(void 0)}),s.promise}}]),e.factory("User",["UserBase","$q","$http","Search","Conversation","SessionBase","Evnt","Messages",function(e,t,r,s,n,a,o,i){return e.search=function(s){var n=t.defer(),a=r({method:"GET",url:"/api/usersearch",params:s});return a.then(function(t){for(var r=[],s=0;s<t.data.data.length;s++)r.push(e.make(t.data.data[s]));n.resolve(r)},function(e){n.reject(e.message)}),n.promise},e.prototype.cleanInstitutionAssociations=function(){for(var e=[],t=0;t<this.institution_associations.length;t++){var r=this.institution_associations[t];r.institution&&r.institution.name&&e.push(r)}this.institution_associations=e},e.prototype.addInstitutionAssociationRemoveMethod=function(e){var t=this;e.remove=function(){var r=t.institution_associations.indexOf(e);r>-1&&t.institution_associations.splice(r,1)}},e.prototype.updateFromData=function(e){if(this._baseUpdateFromData(e),this.educator_profile_search?this.educator_profile_search=new s(this.educator_profile_search):this.educator_profile_search=new s({searcher_user_id:this.id,searcher_role:"educator",searching_for_role:"partner",zipcode:this.zipcode,labels:[]}),this.community_partner_profile_search?this.community_partner_profile_search=new s(this.community_partner_profile_search):this.community_partner_profile_search=new s({searcher_user_id:this.id,searcher_role:"partner",searching_for_role:"educator",zipcode:this.zipcode,labels:[]}),this.is_administrator?this.accountCreationStatus="done":0===this.educator_profile_search.labels.length&&0===this.community_partner_profile_search.labels.length?this.accountCreationStatus="choice":this.bio?this.accountCreationStatus="done":this.accountCreationStatus="personal",void 0===this.institution_associations)this.institution_associations=[],this.addNewInstitutionAssociation();else for(var t=0;t<this.institution_associations.length;t++){var r=this.institution_associations[t];this.addInstitutionAssociationRemoveMethod(r)}},e.prototype.initialize=function(){var e=this;if(a.activeUser){var t=n.get_many({user_id:a.activeUser.id});t.then(function(t){e.conversationsWithMe=[];for(var r=0;r<t.length;r++){var s=t[r];s.otherUser.id===e.id&&e.conversationsWithMe.push(s)}})}},e.prototype.addNewInstitutionAssociation=function(){var e={institution:{},role:""};this.institution_associations.push(e),this.addInstitutionAssociationRemoveMethod(e)},e.getByEmail=function(s){var n=t.defer(),a=r({method:"GET",url:"/api/userbyemail/"+s});return a.then(function(t){var r=e.make(t.data.data);n.resolve(r)},function(e){n.reject(e.message)}),n.promise},e.prototype.getSearches=function(){var e={searcher_user_id:this.id,active:!0},t=s.get_many(e);return t},e.prototype.getRecentConversations=function(){var e=new Date,t=new Date(e.getFullYear(),e.getMonth()-1,e.getDate()),r={user_id:this.id,"messages.date_created.greaterthan":t},s=n.get_many(r,!0);return s},e.prototype.getUpcomingEvents=function(){var e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate()),r={user_id:a.activeUser.id,"datetime_start.greaterthan":t},s=o.get_many(r);return s},e.prototype.updateUnviewedConversations=function(){var e=this,t=n.getUnviewedForUser(this.id);t.then(function(t){for(var r=0,s=0;s<t.length;s++){var n=t[s],a=n.getUnviewedMessages();r+=a.length}e.nUnviewedMessages=r},function(e){var t="";e&&(t=": "+e),i.error("Failed to get messages: "+t)})},e}]),e.factory("Institution",["itemFactory",function(e){var t=e("institution");return t}]),e.factory("startConversation",["$modal","$location","Conversation","Messages",function(e,t,r,s){var n=function(n,a,o,i){var c,u=a.id;o&&(c=o.id);var l=r.get_many({user_id:n.id,other_user_id:a.id},!0),d={templateUrl:"./static/templates/new_conversation.html",controller:"NewConversationController",resolve:{userId:function(){return u},searchId:function(){return c}}},h=function(e){e&&i&&t.path("/conversation/"+e.id)};l.then(function(r){if(1===r.length)t.path("/conversation/"+r[0].id);else if(0===r.length){var s=e.open(d);s.result.then(h)}else{var n={templateUrl:"./static/templates/choose_conversation.html",controller:function(e){e.conversations=r,e.showConversation=function(e){t.path("/conversation/"+e.id)}}};e.open(n)}},function(e){s.info(e)})};return n}])},function(e,t,r){"use strict";var s=r(1),e=s.module("communityshare.services.utility",[]);e.factory("support",function(){var e=function(e,t){var r,s="IE",n=document.createElement("B"),a=document.documentElement;return e&&(s+=" "+e,t&&(s=t+" "+s)),n.innerHTML="<!--[if "+s+']><b id="iecctest"></b><![endif]-->',a.appendChild(n),r=!!document.getElementById("iecctest"),a.removeChild(n),r};return{nativePlaceholderSupport:function(){var e=document.createElement("input");return void 0!==e.placeholder}(),isIE:e,fileUploader:!e(8,"lte")}}),e.filter("truncate",function(){return function(e,t,r){void 0===r&&(r="...");var s;return s=e.length<=t||e.length-r.length<=t?e:String(e).substring(0,t-r.length)+r}}),e.factory("parseyyyyMMdd",function(){return function(e){var t=new Date(e.substring(0,4),e.substring(4,6),e.substring(6,8));return t.setMonth(t.getMonth()-1),t}})}]);
//# sourceMappingURL=bundle.js.map